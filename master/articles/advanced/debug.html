<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Debugging with dnSpy </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Debugging with dnSpy ">
    <meta name="generator" content="docfx 2.47.0.0">
    
    <link rel="shortcut icon" href="../../favicon.ico">
    <link rel="stylesheet" href="../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../styles/docfx.css">
    <link rel="stylesheet" href="../../styles/main.css">
    <meta property="docfx:navrel" content="../../toc.html">
    <meta property="docfx:tocrel" content="../toc.html">
    <meta property="docfx:urlPrefix" content="/bepinex_docs/">
    
    
    
  </head>  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../../index.html">
                <img id="logo" class="svg" src="../../logo.svg" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
              <div class="version-selector" style="display: none;">
                <span>Version:</span>
                <form>
                    <select class="versions-dropdown"></select>
                </form>
              </div>
            </div>
          </div>
        </nav>        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div role="main" class="container-fluid body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-7">
            <article class="content wrap" id="_content" data-uid="">

<p>Debugging BepInEx plugins can pose a challenge depending on the game and the plugin.<br>
Currently there are two ways to debug plugins and Unity games</p>
<ol>
<li>Using dnSpy and its debug builds of the Mono runtime</li>
<li>Converting the game to debug build and using Visual Studio Tools for Unity (or Rider's Unity extension)</li>
</ol>
<h1 id="debugging-with-dnspy">Debugging with dnSpy</h1>
<h2 id="turning-the-game-into-a-debug-build">Turning the game into a debug build</h2>
<div class="NOTE">
<h5>Note</h5>
<p>This guide's step is mainly a basic overview of what to do.
For a full guide on turning your game into a debug build, check out <a href="https://github.com/0xd4d/dnSpy/wiki/Debugging-Unity-Games#debugging-release-builds">the offical dnSpy's guide on this topic.</a>.</p>
</div>
<p>First, the game's mono runtime has to be swapped to one that supports debugging with dnSpy.<br>
For that, you need to know the Unity version your game has been built against.<br>
You can do that by checking file properties of the game EXE or by running BepInEx,
which will log the Unity version of the game in the console (or into <code>BepInEx/LogOutput.txt</code>):</p>
<pre><code>[Message:   BepInEx] BepInEx 5.0.1.0 - &lt;Game Name&gt;
[Info   :   BepInEx] Running under Unity v5.4.0.6710170
[Info   :   BepInEx] CLR runtime version: 2.0.50727.1433
...
</code></pre>
<p>Next, head to <a href="https://github.com/0xd4d/dnSpy/releases">dnSpy releases</a> and download one of the debug Mono packages
that <strong>corresponds to the Unity version of your game</strong>:
<img src="images/dnSpy_debug.png" alt="Download one of the debug packages that corresponds to the Unity version of your game.">
For example, in the log above Unity version is <code>5.4.0</code>, in which case one has to download <code>Unity-debugging-5.x.zip</code>.</p>
<p>Open the downloaded archive and locate <code>mono.dll</code> that corresponds to your Unity game <strong>version</strong> and
executable target (32 bit or 64 bit). Finally, locate the same DLL in your game folder and replace it with the one from dnSpy.</p>
<h2 id="setting-up-dnspy-and-setting-breakpoints">Setting up dnSpy and setting breakpoints</h2>
<p>Download the <a href="https://github.com/0xd4d/dnSpy/releases">latest version of dnSpy</a>. You can pick any of the available versions.</p>
<p>Extract the downloaded archive and run dnSpy.</p>
<p>Next, drag the plugins DLLs you want to debug into dnSpy.</p>
<div class="NOTE">
<h5>Note</h5>
<p>You must select the DLL that is in your <code>BepInEx</code> folder, and not the one in your Visual Studio solution!</p>
</div>
<p><img src="images/dnSpy_dragndrop.png" alt="Drag and drop the DLL you want to debug on dnSpy's assembly list."></p>
<p>You can change the settings of dnSpy via <code>View &gt; Options</code>.</p>
<p>To set a breakpoint, navigate the assembly you want to debug and right click on the piece of code you want to debug.<br>
Next, select <code>Add breakpoint</code> to set the breakpoint:</p>
<p><img src="images/dnSpy_set_breakpoint.png" alt="Right-click on the piece of code as select &quot;Add breakpoint&quot; to add a breakpoint."></p>
<p>Note that some code might not be selectable. In that case you can change dnSpy to show the precise IL code from the dropdown in the top bar.</p>
<h2 id="running-the-game-via-dnspy">Running the game via dnSpy</h2>
<p>After you have set the breakpoints, you can start debugging the game.</p>
<p>Select <code>Debug &gt; Start Debugging</code> to open up the <em>Debug Program</em> dialog.</p>
<p>Change the settings as follows:</p>
<ul>
<li><em>Debug Engine</em>: Select <strong>one</strong> of the following:
<ul>
<li><code>Unity</code> if you want dnSpy to start the game for you</li>
<li><code>Unity (Connect)</code> if you want to start debugging when the game is on</li>
</ul>
</li>
<li><em>Executable</em> (only in <code>Unity</code> engine): Locate and select the game's executable from the game's installation directory.</li>
<li><em>Timeout (s)</em> (only in <code>Unity</code> engine): 30. You can optionally set it to higher values if the game loads too slow.</li>
<li><em>IP Address</em> (only in <code>Unity (Connect)</code> engine): Leave it blank</li>
<li><em>Port</em> (only in <code>Unity (Connect)</code> engine): 55555</li>
</ul>
<p><img src="images/dnSpy_start_debug.png" alt="dnSpy's Debug Program dialog."></p>
<p>Finally, press <code>OK</code> to start the game (or to attach dnSpy to an already running game).</p>
<p>Wait until the game loads your assembly. If everything worked correctly, the execution will stop on the breakpoint:</p>
<p><img src="images/dnSpy_breakpoint_hit.png" alt="dnSpy window when the game hits a breakpoint."></p>
<p>From there, you can do same things like in the normal debugger:</p>
<ul>
<li>Inspect locals and type members</li>
<li>Step into, step over, set more breakpoints (via the top bar)</li>
<li>Modify values (in some cases)</li>
</ul>
<p>Note that when you step in dnSpy, it steps one IL instruction at a time (in which case one single expression can take multiple steps to move over).</p>
<h2 id="debugging-patched-assemblies">Debugging patched assemblies</h2>
<p>In some cases it is useful to be able to also debug assemblies that have been patched via BepInEx's preloader.<br>
However, this is very difficult, as the preloader patches and loads assemblies directly in memory, which makes debugging with dnSpy impossible without additional tinkering.</p>
<h3 id="using-bepinex-loaddumpedassemblies-option">Using BepInEx <code>LoadDumpedAssemblies</code> option</h3>
<p>BepInEx includes two new configuration options: <code>LoadDumpedAssemblies</code> and <code>BreakBeforeLoadAssemblies</code>. With these, it is possible to debug assemblies loaded via the preloader (i.e. Assembly-CSharp).</p>
<p>First <a href="#turning-the-game-into-a-debug-build">install debug version of mono</a> and <a href="https://github.com/0xd4d/dnSpy/releases">download dnSpy</a> if you haven't done so yet.</p>
<p>Run the game once in order for BepInEx to generate its full configuration file.<br>
Then, open to <code>BepInEx/config/BepInEx.cfg</code> and edit the the two configuration options to have the following values:</p>
<pre><code class="lang-ini">LoadDumpedAssemblies = true

BreakBeforeLoadAssemblies = true
</code></pre>
<p>After that <a href="#running-the-game-via-dnspy">run the game via dnSpy</a>.</p>
<div class="WARNING">
<h5>Warning</h5>
<p><strong>The assemblies in <code>DumpedAssemblies</code> must not be opened before debugging!</strong>
This is because otherwise BepInEx will not be able to write to the folder!</p>
</div>
<p>If everything worked, BepInEx will launch, patch assemblies and automatically break the execution and display a message in console:</p>
<p><img src="images/bepin_breakpoint_hit.png" alt="dnSpy stopped at a breakpoint set by BepInEx"></p>
<p>Now go to <code>BepInEx/DumpedAssemblies</code> (as specified in the console), open patched assemblies you want to debug and set breakpoints.
When you're done, click <code>Continue</code> in the top bar to continue execution.</p>
<p>BepInEx will continue loading the patched assemblies. If everything worked, you will eventually hit a breakpoint in the patched assembly:</p>
<p><img src="images/dnSpy_asscsharp_beakpoint_hit.png" alt="Debugging patched assemblies works with dnSpy"></p>
<h3 id="using-dnspys-module-view">Using dnSpy's module view</h3>
<p>In Debug mode, dnSpy provides the ability to access all assemblies that are loaded in memory.<br>
That way you are able to access all
assemblies that were loaded in memory -- even dynamic assemblies (ones generated by Harmony, for example).</p>
<p>When in debug mode, open the modules window by selecting <code>Debug &gt; Windows &gt; Modules</code></p>
<p><img src="images/dnSpy_modules.png" alt="Debug &gt; Windows &gt; Modules in dnSpy"></p>
<p>The opened tab shows all modules already loaded into memory:</p>
<p><img src="images/dnSpy_modules_view.png" alt="Modules view">
You can open modules by double-clicking them. This opens them in dnSpy, after which you can
put breakpoints like you normally would.</p>
<p>Finally, it's possible to put breakpoints for when an assembly has been loaded.
For that, select <code>Debug &gt; Windows &gt; Module Breakpoints</code>. This will open a window into which
you can put the names of the modules to break on.</p>
<p><img src="images/dnSpy_module_breakpoints.png" alt="Module breakpoints window"></p>
<h1 id="debugging-plugins-with-visual-studio-tools-for-unity">Debugging plugins with Visual Studio Tools for Unity</h1>
<div class="NOTE">
<h5>Note</h5>
<p>This method is suitable for debugging only BepInEx plugins!
To debug prelaoder plugins, please refer to the guide above on how to use dnSpy's debug Mono.</p>
</div>
<p>While debugging with dnSpy is rather simple, you might want to debug directly in
Visual Studio while developing. It is possible to debug your plugins with the help of
Visual Studio Tools for Unity (VSTU).</p>
<h2 id="installing-required-tools">Installing required tools</h2>
<p>First, you have to convert the game to debug build. To do that, <a href="https://github.com/0xd4d/dnSpy/wiki/Debugging-Unity-Games#turning-a-release-build-into-a-debug-build">refer to dnSpy guide on converting the game to pure debug build</a>.</p>
<p>Next, install VSTU. You can do so in Visual Studio 2019 via Visual Studio Installer.
You can find the component behind <code>Individual components</code> tab:
<img src="images/vstu_select.png" alt="Select &quot;Visual Studio Tools for Unity&quot; component in Visual Studio installer"></p>
<div class="NOTE">
<h5>Note</h5>
<p>Rider provides a similar Unity extension which allows for the same debugging functionality.</p>
</div>
<h2 id="compiling-your-project">Compiling your project</h2>
<p>Next, compile your BepInEx plugin with a <code>Debug</code> build. <strong>Make sure that you generate a <code>.pdb</code> file!</strong></p>
<p>Place your BepInEx plugin into <code>BepInEx\plugins</code> like you normally would but with the <code>.pdb</code> file accompanying it:</p>
<p><img src="images/vstu_plugin_install.png" alt="Install your plugin with the .pdb file normally into BepInEx/plugins folder."></p>
<h2 id="converting-pdb-to-mdb">Converting <code>.pdb</code> to <code>.mdb</code></h2>
<p>Since Unity uses Mono as its .NET runtime, it cannot directly read <code>.pdb</code> files which contains the required debug symbols.
Instead, it uses <code>.mdb</code> files for the similar task. Because of this, <code>.pdb</code> file needs to be converted.</p>
<p>Grab <code>pdb2mdb</code> converter (for example, from <a href="https://www.nuget.org/packages/Mono.pdb2mdb/">NuGet</a> or from <a href="https://gist.github.com/jbevain/ba23149da8369e4a966f#file-pdb2mdb-exe">GitHub</a>). Put the executable in some folder <strong>except not into BepInEx plugin folder</strong>.</p>
<p>Finally, simply drag-and-drop your plugin DLL file, which will generate the required debug symbols:</p>
<p><img src="images/vstu_pdb2mdb.gif" alt="Convert pdb to mdb by dragging and dropping the plugin DLL onto the pdb2mdb.exe"></p>
<p>After this, you can optionally delete the <code>.pdb</code> file as it is not needed.</p>
<h2 id="starting-debugging">Starting debugging</h2>
<p>Finally, put breakpoints in Visual Studio however you want and start the game.
When the game has started, you're ready to start debugging.</p>
<p>In Visual Studio, select <code>Debug &gt; Attach Unity Debugger</code>:</p>
<p><img src="images/vstu_debugger_select.png" alt="Select Debug &gt; Attach Unity Debugger in Visual Studio"></p>
<p>In the opened dialog, select the game executable and press <code>OK</code>:</p>
<p><img src="images/vstu_select_process.png" alt="Select the game process from the opened dialog"></p>
<div class="NOTE">
<h5>Note</h5>
<p>If there is no processes in the list, try pressing <code>Refresh</code> -- it might be that the game hasn't loaded in yet.<br>
It is also may be because you didn't follow the <a href="https://github.com/0xd4d/dnSpy/wiki/Debugging-Unity-Games#turning-a-release-build-into-a-debug-build">dnSpy debug build conversion guide</a> properly.
In that case, please repeat the steps in that setup guide making sure you use correct Unity version and bitness.</p>
</div>
<p>If you've done everything correctly, the debugging session starts and your breakpoints can be hit:</p>
<p><img src="images/vstu_works.png" alt="An example of a breakpoint being hit"></p>
</article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/BepInEx/bepinex_docs/blob/c48150ff579acae34e79d317aa90bd4c77823482/articles/advanced/debug.md/#L1" class="contribution-link">Improve this Doc</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            
            <span>Generated by <strong>DocFX</strong></span>
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../styles/main.js"></script>
  </body>
</html>
